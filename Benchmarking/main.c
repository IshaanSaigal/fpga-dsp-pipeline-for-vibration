/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2025 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "arm_math.h" 	// The CMSIS-DSP library header
#include <stdio.h>   	// For using sprintf to format the output string
#include <string.h>  	// For using strlen

/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
#define FFT_SIZE 1024

/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
UART_HandleTypeDef huart2;

/* USER CODE BEGIN PV */

// NOTE: We need to store the following variables as "const" to ensure that they
// don't get saved in RAM.


// The raw 16-bit MPU-6050 accelerometer readings for each axis:
static const q15_t input_accel_x[FFT_SIZE] = {59409, 57902, 62733, 63428, 60936, 60886, 60191, 62736, 63261, 59147, 64492, 60350, 58249, 62484, 60171, 58600, 60985, 61505, 63801, 58578, 61380, 64825, 60478, 58899, 61451, 61385, 60175, 60094, 64183, 60118, 57495, 61841, 62993, 59655, 61637, 62149, 62801, 60830, 61558, 64746, 60952, 58772, 63628, 60884, 59892, 61025, 61404, 60757, 58164, 61292, 64463, 59294, 62028, 62100, 61058, 61399, 61852, 63338, 60176, 58344, 63396, 60873, 59971, 60826, 62127, 61448, 58413, 62274, 64288, 60241, 62762, 63407, 61407, 60167, 59898, 63600, 60125, 57701, 62123, 60461, 59966, 61997, 62203, 61107, 59262, 63146, 65268, 59788, 62737, 63500, 60681, 59049, 59024, 64352, 64623, 59218, 62101, 64353, 57794, 61783, 61720, 61165, 61692, 62389, 63839, 61224, 58050, 64891, 60248, 59701, 61690, 61817, 59400, 58061, 61854, 87, 58658, 61204, 63343, 60239, 59429, 61455, 62462, 61370, 58405, 62088, 60637, 59059, 62480, 61792, 60109, 60633, 61947, 63872, 60379, 61231, 63499, 61139, 59037, 63295, 61971, 59989, 59408, 61929, 60711, 57301, 62114, 63581, 60017, 62426, 59981, 59976, 59833, 61263, 64632, 60455, 59236, 61782, 59510, 58651, 61854, 62465, 61738, 58779, 61985, 64734, 59875, 62965, 63513, 60554, 59941, 60184, 64054, 61265, 58397, 62915, 61500, 59726, 61562, 59960, 62076, 58732, 62340, 63793, 60962, 59069, 63242, 61743, 60658, 58768, 65409, 59259, 58667, 62503, 62214, 60674, 59740, 60228, 63914, 60581, 62478, 62856, 60117, 60122, 61731, 63620, 61591, 58245, 62071, 60584, 59826, 61975, 61449, 63093, 59199, 61868, 64541, 60378, 61977, 62279, 62696, 60607, 58453, 65218, 60534, 58566, 62458, 61043, 60699, 61489, 61395, 62973, 58415, 63884, 63112, 58313, 58964, 59671, 61772, 61482, 58558, 62205, 61494, 57853, 62650, 63554, 61290, 59980, 60939, 62650, 60709, 61809, 63940, 59878, 57798, 62307, 60991, 61052, 59688, 60436, 60271, 58757, 61606, 62031, 60992, 60250, 61986, 64704, 61118, 62099, 701, 60464, 60986, 61315, 62846, 61011, 58258, 62127, 61705, 60003, 60504, 62259, 62474, 58891, 60626, 64802, 61078, 59036, 63532, 59781, 61464, 60269, 63691, 60829, 58500, 62081, 62978, 60128, 61428, 61897, 62532, 61366, 60514, 64783, 60688, 59743, 60139, 59839, 59949, 60062, 62276, 61343, 60414, 61938, 62783, 60793, 60678, 60174, 61579, 60668, 62264, 62026, 59894, 58750, 62152, 62144, 61191, 59197, 59472, 61473, 59291, 62526, 63202, 61470, 60247, 61304, 63880, 60861, 58790, 62171, 60541, 59387, 61502, 63893, 60995, 58779, 61057, 61908, 61193, 61645, 61809, 62282, 59170, 61635, 64410, 60999, 58683, 63097, 60845, 61289, 60364, 61323, 60932, 57239, 61821, 62032, 59942, 60170, 61843, 63279, 61611, 61678, 63235, 60793, 59539, 61590, 62453, 61534, 58939, 60497, 59649, 58978, 61670, 63598, 59807, 60968, 61761, 63492, 61274, 57966, 64421, 60835, 59819, 61727, 63220, 61278, 58419, 61359, 65275, 57868, 62399, 63723, 61729, 59622, 61618, 63836, 61675, 59164, 64861, 60498, 58804, 61712, 62556, 60434, 57732, 62269, 62815, 59024, 62325, 63732, 61265, 59953, 61971, 63296, 62097, 58537, 61622, 61137, 58333, 62251, 62881, 62610, 61643, 59990, 62365, 62042, 61995, 62116, 58336, 58562, 62011, 62491, 60235, 59339, 62033, 61079, 58352, 62087, 64187, 60025, 60828, 61796, 63502, 60189, 61437, 64783, 60137, 58704, 62416, 60590, 59926, 60581, 61862, 63193, 58989, 61660, 64536, 60279, 62107, 62305, 61346, 61715, 60109, 62937, 60904, 57812, 61940, 64240, 60293, 61679, 60986, 61190, 58735, 60907, 62969, 61265, 57866, 62810, 61212, 60993, 62206, 61346, 61412, 59346, 61768, 65383, 58669, 61490, 61021, 60238, 60591, 60418, 63126, 58973, 60308, 65496, 61179, 57550, 60425, 63431, 60503, 59873, 61305, 64036, 62053, 61249, 65050, 61804, 58703, 63017, 60042, 58789, 59898, 61213, 60379, 57330, 61690, 65336, 60126, 61652, 61334, 58943, 60186, 62089, 63350, 59597, 57851, 61970, 60611, 57864, 62202, 63606, 58020, 60941, 59563, 62982, 62061, 61144, 64237, 61074, 58538, 62354, 61492, 60125, 60617, 60913, 61081, 58882, 61655, 63794, 60857, 62041, 63192, 60859, 59869, 60276, 63536, 59737, 58748, 61458, 60943, 57544, 62249, 61764, 61657, 60471, 58503, 62440, 58564, 60859, 63770, 60934, 60712, 62275, 61724, 60896, 58987, 61693, 64494, 58544, 62097, 63371, 61183, 61359, 60979, 62281, 61375, 58775, 64552, 61259, 57687, 61912, 62681, 60547, 60804, 61543, 63622, 58871, 61101, 63855, 60817, 59027, 62137, 60569, 60519, 61521, 61042, 61332, 58860, 61239, 61982, 59105, 61897, 62634, 61108, 60799, 61220, 64086, 60489, 58429, 64287, 60809, 59345, 61927, 62382, 60582, 60559, 61403, 63741, 61661, 62236, 63368, 60156, 60190, 62833, 62521, 61336, 60420, 61029, 61006, 58288, 62556, 63472, 59869, 62536, 61121, 63733, 65261, 62535, 64286, 61307, 60337, 63301, 60843, 59544, 61123, 62264, 61058, 57977, 61874, 64335, 60950, 62146, 61973, 61519, 61904, 59962, 64035, 60816, 57903, 61727, 61270, 59254, 62064, 61273, 61783, 61435, 61508, 64301, 60349, 58538, 62547, 60150, 58808, 60973, 59791, 60961, 58437, 61314, 63752, 58290, 62601, 64204, 60496, 60525, 61369, 62602, 60647, 57989, 63289, 59677, 58747, 62911, 63928, 59664, 61012, 61722, 62175, 59698, 62328, 63794, 60751, 58371, 62462, 61521, 60140, 60770, 60715, 60572, 59169, 62051, 64118, 58108, 63654, 63966, 60092, 59820, 62652, 62489, 61318, 58813, 63018, 59864, 58863, 61907, 63297, 60543, 60893, 60977, 63728, 59696, 62277, 62407, 59294, 59950, 61311, 59746, 61128, 59889, 61938, 58817, 59042, 62619, 61361, 60039, 61486, 61106, 63221, 61378, 61786, 62623, 60203, 59369, 62403, 61437, 61277, 61065, 61310, 62183, 58694, 61441, 61073, 60284, 62501, 60856, 61557, 61428, 60055, 64122, 60463, 57965, 62152, 61698, 58505, 61310, 61154, 62771, 59298, 61782, 64484, 60189, 59613, 62515, 61187, 61851, 59762, 61809, 60506, 59657, 63903, 60914, 59590, 62011, 60557, 60869, 61169, 62362, 63936, 58984, 58945, 61047, 59930, 61101, 62033, 60336, 59778, 57052, 62531, 60532, 61298, 61363, 61531, 63093, 61088, 61602, 63163, 63051, 59034, 62356, 61698, 60680, 59829, 60466, 62408, 58353, 61932, 62749, 60826, 61017, 60945, 63281, 60996, 59574, 63741, 60637, 59919, 63205, 59767, 61181, 60589, 61725, 62252, 58270, 62035, 63404, 60969, 61143, 60667, 62429, 60388, 57640, 64099, 61542, 59925, 61574, 60725, 62166, 59856, 61766, 63635, 61008, 61923, 62852, 61733, 60028, 60292, 63748, 61911, 58506, 61170, 61158, 59899, 61386, 61774, 61335, 59694, 61575, 64421, 60576, 61940, 60813, 60991, 61056, 61997, 61781, 60799, 59658, 61254, 61563, 60062, 62483, 62374, 60944, 60704, 63154, 64528, 60424, 58750, 62284, 60004, 59700, 62498, 62467, 61146, 58864, 61083, 65148, 59454, 61507, 62609, 61153, 60522, 61489, 61758, 60074, 59176, 63780, 60378, 59762, 62313, 61825, 61831, 60100, 61439, 63256, 59328, 62269, 61621, 59039, 60470, 61000, 62566, 62305, 59496, 61369, 61121, 59685, 62406, 62573, 61601, 60242, 60960, 62609, 60938, 61856, 63398, 60497, 60061, 61936, 61940, 62216, 59591, 60384, 60956, 59744, 62521, 63298, 60442, 61723, 61630, 62550, 62226, 61341, 63649, 61489, 59628, 61916, 60861, 60097, 61461, 61410, 62634, 59518, 59962, 62878, 60991, 63129, 60693, 61171, 60831, 62928, 62173, 62961, 59443, 61195, 63267, 59528, 62121, 62352, 60504, 61072, 61052, 62890, 62121, 60063, 63837, 60882, 58677, 62322, 61064, 60650, 60556, 60448, 63111};
static const q15_t input_accel_y[FFT_SIZE] = {65297, 1326, 64525, 63940, 264, 214, 64543, 1296, 64541, 11, 64748, 446, 649, 64276, 1547, 65000, 65337, 64065, 825, 64978, 64708, 313, 64574, 787, 64011, 713, 1039, 64190, 1207, 214, 65431, 64913, 64785, 519, 64197, 64965, 593, 926, 63350, 1002, 1048, 64660, 652, 65236, 65524, 65377, 64476, 853, 63796, 64876, 463, 65438, 64076, 404, 642, 64983, 668, 65130, 272, 65256, 63652, 969, 63811, 64154, 1199, 65032, 63789, 322, 288, 81, 42, 64943, 735, 7, 63226, 1136, 63965, 64101, 939, 45, 64574, 65325, 251, 64947, 1150, 65194, 500, 65420, 63249, 1548, 64265, 64169, 912, 65120, 65391, 65106, 64661, 353, 65474, 64855, 1048, 65517, 65020, 181, 351, 62760, 1218, 64123, 64088, 1333, 65018, 121, 63752, 717, 1438, 64087, 802, 276, 65135, 63311, 549, 64527, 64254, 1210, 64805, 392, 64989, 435, 528, 63840, 64973, 1241, 65531, 63104, 1755, 64815, 64267, 723, 413, 64575, 19, 65109, 272, 65513, 551, 725, 64162, 64861, 625, 65242, 63309, 1096, 697, 64335, 1144, 65319, 100, 64854, 374, 27, 64926, 61697, 298, 64411, 63777, 1502, 64227, 64501, 537, 138, 64037, 65304, 63798, 1361, 64541, 63427, 572, 64334, 64378, 1080, 65404, 64876, 388, 817, 65314, 63933, 64778, 815, 242, 63888, 385, 63867, 64043, 1063, 65286, 64258, 92, 324, 65450, 64677, 64526, 648, 65493, 63450, 1059, 64132, 63383, 1925, 65399, 64936, 178, 535, 65289, 64373, 65343, 172, 65309, 64730, 1049, 64071, 63976, 1215, 597, 64194, 118, 966, 64762, 371, 64539, 305, 211, 64253, 1583, 63884, 63624, 1481, 340, 64023, 1100, 298, 64702, 765, 65078, 509, 65466, 63810, 874, 63564, 64523, 954, 37, 64369, 1476, 230, 64198, 355, 64319, 636, 40, 63764, 623, 63877, 64678, 335, 832, 63322, 1314, 704, 64446, 1427, 65469, 304, 65082, 65155, 638, 64083, 64914, 175, 65033, 64099, 1368, 51, 64010, 1547, 466, 34, 63894, 65436, 1324, 65413, 64280, 65389, 63691, 65181, 900, 897, 64258, 480, 1268, 457, 62788, 438, 354, 64527, 528, 64863, 65259, 63423, 557, 1694, 64836, 1695, 766, 63730, 64575, 633, 65030, 64526, 65419, 252, 64824, 64842, 246, 638, 64712, 1216, 775, 64573, 63824, 289, 64667, 63550, 738, 30, 64855, 64888, 65416, 957, 65446, 987, 637, 64251, 64062, 65173, 65347, 65179, 385, 65236, 64009, 205, 113, 586, 64802, 195, 922, 65351, 63291, 889, 64429, 64105, 1228, 64907, 65028, 65175, 381, 336, 65318, 65290, 403, 303, 63403, 1262, 64003, 63609, 1683, 65430, 65269, 65118, 571, 81, 1, 64866, 998, 110, 63135, 1576, 64321, 63748, 1114, 65134, 64677, 419, 65195, 64799, 65268, 862, 307, 65455, 63739, 1548, 63679, 64747, 289, 230, 63666, 604, 235, 65308, 605, 64594, 180, 784, 63580, 274, 64132, 64829, 351, 64400, 64885, 1524, 65105, 65329, 19, 320, 65425, 64425, 182, 1233, 477, 63019, 417, 65170, 63435, 1366, 65437, 64858, 811, 64932, 65504, 194, 64059, 795, 64587, 64715, 65361, 407, 63984, 647, 443, 65145, 1180, 64612, 526, 64285, 65533, 271, 65257, 64080, 65232, 65198, 63254, 1189, 934, 64217, 109, 64476, 64792, 631, 155, 1121, 162, 64531, 1229, 63449, 64232, 1236, 65012, 65008, 64901, 751, 314, 63494, 111, 491, 64249, 64337, 65290, 65114, 63772, 833, 254, 63906, 1252, 722, 64584, 64359, 64557, 306, 349, 63566, 431, 64514, 64150, 93, 660, 64984, 65531, 64718, 65289, 64455, 65111, 737, 65401, 63780, 357, 64321, 64282, 876, 335, 63785, 650, 677, 64762, 64541, 64731, 498, 506, 63544, 990, 63700, 64150, 1087, 26, 64393, 65398, 973, 65531, 63506, 65475, 264, 65530, 64374, 932, 64781, 63403, 774, 877, 64216, 65005, 65170, 64938, 64658, 65076, 477, 457, 64241, 1689, 64002, 63703, 1330, 953, 63321, 1240, 65211, 221, 372, 65328, 65369, 64380, 64786, 271, 64968, 63529, 836, 985, 63543, 1415, 65000, 65220, 187, 282, 64774, 64552, 579, 540, 224, 63339, 765, 1518, 64176, 913, 395, 64511, 1455, 64819, 73, 191, 64407, 808, 64331, 64087, 1240, 473, 64131, 1156, 65383, 64902, 1271, 64685, 367, 65425, 63891, 953, 64409, 65127, 337, 65394, 63380, 1516, 567, 64286, 1505, 64201, 426, 692, 63359, 1060, 64086, 62281, 1597, 63519, 64137, 977, 65511, 65454, 934, 655, 64475, 65277, 65501, 28, 904, 62204, 64286, 64113, 62521, 1688, 772, 64613, 590, 64688, 65372, 65520, 64989, 840, 64193, 65013, 237, 327, 63518, 379, 945, 64837, 1707, 65176, 65475, 65336, 65410, 65401, 64690, 335, 65046, 450, 62997, 847, 1232, 64058, 1827, 65168, 47, 64543, 342, 65398, 64368, 345, 65111, 251, 63556, 557, 1213, 64170, 1107, 1014, 65208, 63789, 399, 64545, 65093, 1154, 64520, 64946, 64649, 972, 1104, 64621, 441, 138, 231, 63877, 1593, 64797, 63099, 1215, 65208, 65040, 65108, 65050, 479, 64050, 632, 818, 64591, 64003, 1534, 64081, 64236, 64866, 299, 64412, 1057, 64611, 65398, 64252, 422, 734, 64188, 64172, 188, 25, 63622, 701, 810, 64472, 1263, 65235, 65345, 64383, 733, 49, 65008, 64816, 1605, 64455, 64158, 302, 127, 63330, 456, 1009, 64498, 1729, 64418, 667, 433, 63879, 814, 64946, 64501, 450, 64858, 63903, 1067, 745, 195, 765, 65117, 65161, 64638, 743, 70, 1, 63889, 636, 64037, 64952, 885, 1268, 64407, 64122, 815, 64877, 64968, 258, 137, 65406, 64994, 51, 64930, 64854, 65508, 541, 477, 819, 259, 64667, 63602, 113, 64858, 64521, 415, 65522, 63942, 65083, 141, 453, 497, 1434, 704, 64360, 63553, 65399, 65050, 64685, 593, 432, 64898, 732, 64835, 372, 114, 947, 1371, 63861, 64160, 65186, 187, 64075, 410, 916, 63746, 776, 64949, 50, 200, 753, 1004, 64285, 64922, 65369, 273, 63025, 580, 1206, 64765, 1245, 64783, 65253, 65143, 509, 685, 64029, 65068, 158, 83, 63916, 1321, 727, 63995, 1245, 65508, 65320, 65379, 102, 21, 63878, 65077, 982, 464, 63814, 659, 1104, 64227, 1924, 64805, 124, 644, 260, 64983, 64650, 1010, 65254, 65019, 64202, 65358, 65175, 63790, 1415, 677, 64672, 1524, 65421, 64831, 64384, 813, 64853, 64895, 65290, 65350, 64891, 64158, 787, 678, 64272, 544, 946, 64784, 62984, 1150, 64588, 64356, 1844, 64290, 65283, 63450, 240, 667, 64892, 65342, 579, 64401, 64225, 1130, 63793, 63806, 426, 552, 64292, 2010, 114, 63849, 64129, 1415, 64964, 62975, 792, 65216, 61, 181, 65183, 310, 64840, 64614, 865, 64872, 63161, 64705, 63525, 63942, 365, 64673, 64082, 288, 913, 64522, 416, 64678, 65361, 64925, 65520, 64756, 64520, 711, 65248, 28, 63584, 1081, 322, 64282, 27, 446, 342, 63250, 1437, 63905, 63281, 1772, 220, 64701, 65473, 533, 64994, 64170, 65150, 58, 414, 63551, 665, 64789, 64755, 671, 65488, 64733, 753, 307, 65291, 63267, 65160, 65449, 64400, 1368, 64144, 64380, 682, 64169, 1183, 64605, 64978, 64565, 64882, 136, 1002, 64140, 62752, 1159};
static const q15_t input_accel_z[FFT_SIZE] = {61201, 63278, 13, 964, 63752, 1238, 65055, 65040, 65053, 63243, 1260, 64702, 62857, 532, 63243, 488, 64825, 3393, 64569, 62162, 452, 1081, 63806, 63763, 1547, 64713, 1551, 446, 695, 65494, 65431, 913, 529, 64775, 65477, 1477, 65361, 926, 65142, 1002, 63000, 62612, 1164, 62932, 65268, 64865, 1244, 64853, 62516, 64364, 975, 64670, 1356, 404, 64130, 64727, 64924, 1130, 63760, 63720, 1956, 457, 1091, 1946, 175, 65032, 62765, 834, 1056, 63057, 42, 63407, 1759, 263, 62202, 1136, 63197, 65125, 427, 64557, 318, 63277, 763, 1203, 64126, 1194, 500, 63628, 63505, 780, 1801, 63913, 64400, 864, 63087, 82, 65173, 64865, 64450, 63319, 1304, 65261, 63740, 437, 64607, 552, 65218, 123, 1368, 64565, 64762, 1401, 64520, 65485, 64158, 87, 63266, 63764, 1647, 591, 63269, 64527, 510, 954, 64293, 63368, 2013, 62899, 65040, 608, 65229, 63705, 62715, 896, 1243, 65071, 2059, 65491, 413, 63295, 1043, 1109, 63504, 65001, 551, 63189, 64674, 64861, 1137, 64218, 63053, 2120, 2233, 64335, 2168, 39, 1380, 854, 630, 795, 62878, 64257, 2602, 65179, 65057, 64222, 739, 63477, 61721, 1162, 549, 62744, 64566, 65361, 1053, 707, 2108, 1358, 61818, 62776, 380, 64620, 64900, 63537, 290, 1981, 63754, 1071, 65010, 63376, 897, 891, 65067, 64295, 63494, 1282, 62300, 64324, 65450, 65445, 14, 62856, 2005, 1498, 64035, 644, 663, 65157, 119, 1192, 946, 63255, 63241, 1909, 64063, 65452, 65053, 64986, 281, 64071, 1512, 191, 63061, 706, 64630, 454, 63738, 1139, 1563, 63281, 64979, 1021, 63791, 64396, 64648, 1737, 1620, 63511, 1612, 1578, 62398, 65533, 65078, 1277, 64954, 63554, 1130, 63308, 63755, 1466, 3365, 113, 63684, 742, 1222, 65379, 3647, 1404, 63272, 65300, 1647, 901, 64166, 63055, 1856, 63322, 64802, 448, 64446, 403, 64189, 816, 1594, 62851, 1406, 595, 63634, 65455, 521, 1379, 63064, 64051, 1546, 65035, 210, 65058, 918, 2204, 62508, 1925, 1048, 63341, 203, 413, 1412, 63873, 62466, 1760, 62708, 65225, 836, 182, 98, 271, 2064, 2399, 64491, 1727, 57389, 53662, 58692, 65439, 2046, 65266, 63295, 1913, 63238, 65294, 64907, 1532, 63800, 63818, 1526, 1150, 61128, 2752, 263, 65341, 336, 33, 1435, 63550, 62946, 2334, 64343, 65400, 64392, 64957, 1190, 63963, 2173, 1019, 61758, 1429, 65091, 155, 64897, 64212, 1545, 64461, 65137, 1866, 34, 64195, 63642, 64839, 571, 63353, 2477, 617, 63436, 65163, 65284, 1431, 64637, 64592, 806, 62986, 65427, 63791, 939, 65262, 63235, 633, 659, 60566, 1269, 862, 63547, 64337, 1, 2658, 64742, 366, 3487, 64040, 64577, 772, 65370, 622, 63909, 1187, 2475, 64031, 756, 65118, 64307, 64175, 63995, 2060, 63167, 62955, 801, 63974, 65458, 92, 64747, 796, 1373, 3410, 2228, 63248, 64348, 2322, 64900, 64573, 63839, 1936, 63093, 500, 1105, 817, 1043, 2112, 65425, 1449, 64694, 2001, 1501, 62763, 64417, 402, 64715, 64854, 64157, 858, 63531, 63396, 1760, 962, 63035, 539, 75, 65483, 64593, 1431, 1008, 62855, 64443, 1145, 63388, 100, 526, 1565, 63997, 62735, 1257, 592, 64208, 686, 65046, 64933, 64422, 64473, 1645, 63452, 64280, 1399, 63643, 353, 64930, 787, 1485, 63449, 1512, 1492, 64500, 65264, 389, 4079, 58, 62470, 1903, 64235, 64761, 593, 65034, 65114, 64796, 1345, 254, 64162, 484, 64978, 63304, 65383, 813, 1842, 64605, 64846, 1967, 62722, 64918, 65373, 65172, 64728, 63483, 2766, 1801, 62663, 65367, 64993, 1145, 36, 63333, 833, 64538, 108, 2127, 62505, 65418, 63397, 65018, 3101, 65243, 1522, 65018, 64056, 734, 2004, 662, 63295, 63770, 393, 63094, 205, 65275, 1554, 63939, 64520, 2554, 1398, 420, 13, 1707, 65286, 63341, 2008, 2285, 62610, 65194, 65170, 65332, 64477, 64457, 5873, 2713, 65282, 65495, 64562, 3513, 62553, 1496, 1211, 62685, 64116, 304, 64089, 65148, 63506, 2063, 63176, 41, 2116, 729, 55, 65415, 488, 1476, 62651, 538, 1030, 61736, 1091, 1820, 736, 64619, 63741, 750, 63152, 64401, 1163, 767, 687, 64051, 329, 703, 64151, 65320, 1355, 63575, 64984, 65497, 1155, 64132, 62823, 1414, 63479, 64429, 879, 657, 64915, 64185, 921, 1127, 63313, 62834, 2452, 63724, 55, 1310, 64993, 64201, 64170, 1460, 1407, 63268, 598, 73, 64317, 64543, 1161, 977, 63207, 63406, 166, 62095, 65243, 64509, 477, 65308, 62600, 1276, 1310, 64113, 57, 408, 65284, 869, 1358, 944, 63324, 64240, 1757, 64584, 64961, 64501, 1261, 63303, 63518, 1403, 1969, 63813, 64683, 152, 1219, 64056, 2690, 2169, 62130, 64591, 534, 65474, 64533, 63823, 1232, 1082, 64291, 912, 47, 64543, 63574, 886, 1392, 64345, 64599, 8699, 65092, 813, 65469, 64426, 63571, 63734, 952, 301, 143, 33, 69, 65410, 64776, 1202, 649, 64204, 64080, 1901, 64185, 63882, 63719, 1157, 64569, 63005, 1915, 959, 62648, 65296, 852, 64538, 64479, 562, 1656, 62514, 65103, 1539, 64254, 65105, 63980, 1122, 2091, 62876, 1569, 1123, 374, 65020, 678, 65502, 64956, 63148, 1212, 63257, 64390, 1725, 1322, 65240, 63471, 979, 1601, 63359, 3037, 65329, 61424, 64816, 65349, 967, 64158, 46, 1663, 62562, 64712, 1009, 754, 65217, 63394, 1691, 1457, 62599, 1838, 946, 63989, 65474, 858, 1439, 63275, 63465, 2243, 62205, 65373, 649, 382, 487, 63558, 2561, 1425, 62844, 1573, 440, 65141, 65268, 63895, 1146, 63535, 1133, 3528, 770, 64905, 64382, 482, 1075, 63906, 1878, 740, 29, 1245, 563, 1795, 64155, 62834, 65137, 2138, 65033, 671, 65266, 966, 827, 909, 1477, 62449, 1178, 4032, 64360, 65089, 1143, 1562, 64429, 63825, 2224, 65410, 220, 64835, 65140, 1138, 63667, 1371, 629, 62624, 418, 1467, 3659, 2458, 62868, 2050, 62728, 64437, 1074, 712, 64753, 64236, 3101, 1178, 63321, 2321, 1585, 63300, 65206, 65533, 1501, 64271, 64485, 2935, 63741, 63917, 1821, 3628, 670, 64851, 428, 1065, 62935, 1787, 1245, 63716, 64808, 64611, 64870, 1301, 64390, 1077, 62166, 62672, 1094, 1171, 64592, 63971, 388, 1829, 59516, 1412, 4, 59351, 63370, 3826, 65254, 63739, 64458, 1102, 64407, 63790, 903, 165, 62880, 244, 65165, 831, 64896, 61741, 853, 127, 63242, 64838, 64379, 64670, 65043, 166, 272, 63264, 1458, 1040, 62728, 63870, 76, 64100, 65332, 290, 771, 64986, 63728, 1435, 892, 64062, 579, 145, 64993, 1130, 817, 1086, 62890, 63016, 1060, 63706, 64114, 1129, 2945, 903, 452, 767, 792, 63680, 1853, 1717, 64415, 65078, 840, 64870, 1377, 65384, 185, 64449, 63525, 1734, 1389, 64161, 2130, 1056, 63633, 266, 1440, 1446, 64849, 62621, 1520, 63732, 64776, 1223, 736, 284, 65120, 313, 578, 65306, 1307, 1470, 63318, 64018, 1181, 64417, 65073, 236, 476, 63933, 63425, 277, 1506, 63914, 1150, 570, 65182, 64063, 409, 64789, 63987, 64415, 1488, 63453, 63985, 1587, 779, 64291, 648, 169, 65168, 65112, 912, 1148, 63402, 63401, 1951, 62557, 64210, 53, 114, 65160, 63210, 2956, 3360, 64391};


// --- Buffers and Variables for DSP processing ---

// Buffer for Hamming window coefficients in Q1.15 format
static q15_t hamming_window_coeffs[FFT_SIZE];

// A temporary buffer to hold the data after windowing (also Q1.15 format)
static q15_t windowed_input[FFT_SIZE];

// Buffer for the FFT output. For a Real FFT (real-valued inputs), the output is complex and requires
// twice the space of the real input (interleaved as R, I, R, I, ...).
// Each item in the buffer is still 16-bit and represented in the Q1.15 format.
static q15_t fft_output[FFT_SIZE * 2];

// Buffer for the final magnitude squared output
static q15_t mag_sq_output[FFT_SIZE / 2];
// NOTE: arm_cmplx_mag_squared_q15 is optimized to only produce 512 samples due to symmetry.
// We cannot force it to compute 1024 samples otherwise. Thus, this buffer needs to be N/2 points.

// The instance structure for the Q15 RFFT
arm_rfft_instance_q15 fft_instance;

/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_USART2_UART_Init(void);
/* USER CODE BEGIN PFP */

/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */

/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{

  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_USART2_UART_Init();
  /* USER CODE BEGIN 2 */

  // 1. Enabling DWT Cycle Counter for precise timing
  CoreDebug->DEMCR |= CoreDebug_DEMCR_TRCENA_Msk;
  DWT->CTRL |= DWT_CTRL_CYCCNTENA_Msk;

  // 2. Generating Hamming Window coefficients
  // The coefficients are first calculated as floats, then converted to Q15 format.
  float32_t temp_float_coeff;
  for (int i = 0; i < FFT_SIZE; i++) {
	  temp_float_coeff = 0.54f - 0.46f * arm_cos_f32(2 * PI * i / (FFT_SIZE - 1));	// Formula for Hamming window
	  arm_float_to_q15(&temp_float_coeff, &hamming_window_coeffs[i], 1); // Converting FP32 to Q1.15
  }

  // 3. Initializing the RFFT instance for a 1024-point, Q1.15 fixed-point FFT
  // This initializes the twiddle factors and bit-reversal tables before actually computing the FFT.
  arm_rfft_init_q15(&fft_instance, FFT_SIZE, 0, 1);
  // The '0' indicates a forward FFT. The '1' indicates bit-reversal is enabled.

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
	  uint32_t start_cycles, total_cycles;
	  char msg[64]; // Buffer for the UART message

	  // --- START BENCHMARK ---
	  DWT->CYCCNT = 0; // Reset cycle counter to zero
	  start_cycles = DWT->CYCCNT;

	  // --- Processing X-Axis ---
	  // 1. Apply Hamming Window (element-wise multiplication)
	  arm_mult_q15((q15_t*)input_accel_x, hamming_window_coeffs, windowed_input, FFT_SIZE);
	  // 2. Compute the Real FFT
	  arm_rfft_q15(&fft_instance, windowed_input, fft_output);
	  // 3. Compute the Magnitude Squared of the complex FFT output
	  arm_cmplx_mag_squared_q15(fft_output, mag_sq_output, FFT_SIZE / 2);

	  // --- Processing Y-Axis ---
	  arm_mult_q15((q15_t*)input_accel_y, hamming_window_coeffs, windowed_input, FFT_SIZE);
	  arm_rfft_q15(&fft_instance, windowed_input, fft_output);
	  arm_cmplx_mag_squared_q15(fft_output, mag_sq_output, FFT_SIZE / 2);

	  // --- Processing Z-Axis ---
	  arm_mult_q15((q15_t*)input_accel_z, hamming_window_coeffs, windowed_input, FFT_SIZE);
	  arm_rfft_q15(&fft_instance, windowed_input, fft_output);
	  arm_cmplx_mag_squared_q15(fft_output, mag_sq_output, FFT_SIZE / 2);

	  // --- END BENCHMARK ---
	  total_cycles = DWT->CYCCNT - start_cycles;

	  // Format the result string
	  sprintf(msg, "Total processing cycles for 3 channels: %lu\r\n", total_cycles);

	  // Transmit the result over UART
	  HAL_UART_Transmit(&huart2, (uint8_t*)msg, strlen(msg), HAL_MAX_DELAY);

	  HAL_Delay(1000); // Wait 1 second before running the benchmark again

    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage
  */
  __HAL_RCC_PWR_CLK_ENABLE();
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE3);

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;
  RCC_OscInitStruct.HSEState = RCC_HSE_ON;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
  RCC_OscInitStruct.PLL.PLLM = 4;
  RCC_OscInitStruct.PLL.PLLN = 100;
  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
  RCC_OscInitStruct.PLL.PLLQ = 2;
  RCC_OscInitStruct.PLL.PLLR = 2;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV4;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV2;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_3) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief USART2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_USART2_UART_Init(void)
{

  /* USER CODE BEGIN USART2_Init 0 */

  /* USER CODE END USART2_Init 0 */

  /* USER CODE BEGIN USART2_Init 1 */

  /* USER CODE END USART2_Init 1 */
  huart2.Instance = USART2;
  huart2.Init.BaudRate = 115200;
  huart2.Init.WordLength = UART_WORDLENGTH_8B;
  huart2.Init.StopBits = UART_STOPBITS_1;
  huart2.Init.Parity = UART_PARITY_NONE;
  huart2.Init.Mode = UART_MODE_TX_RX;
  huart2.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  huart2.Init.OverSampling = UART_OVERSAMPLING_16;
  if (HAL_UART_Init(&huart2) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN USART2_Init 2 */

  /* USER CODE END USART2_Init 2 */

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
/* USER CODE BEGIN MX_GPIO_Init_1 */
/* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOC_CLK_ENABLE();
  __HAL_RCC_GPIOH_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_GPIOB_CLK_ENABLE();

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(LD2_GPIO_Port, LD2_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin : B1_Pin */
  GPIO_InitStruct.Pin = B1_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_FALLING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(B1_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : LD2_Pin */
  GPIO_InitStruct.Pin = LD2_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(LD2_GPIO_Port, &GPIO_InitStruct);

/* USER CODE BEGIN MX_GPIO_Init_2 */
/* USER CODE END MX_GPIO_Init_2 */
}

/* USER CODE BEGIN 4 */

/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
